
# 1、使用场景
新闻客户端推荐系统实现推送去重
使用新闻客户端看新闻时，它会给我们不停地推荐新的内
容，它每次推荐时要去重，去掉那些已经看过的内容。

历史记录存储在关系数据库里，去重就需要频繁地对数据库进行 exists 查
询，当系统并发量很高时，数据库是很难扛住压力

历史记录存储在缓存里，需要大量存储空间，并且随着时间线性增长。

布隆过滤器专门用于解决类似的去重问题。

# 2、布隆过滤器是什么？

* 巴顿.布隆于一九七零年提出
* 一个很长的二进制向量 （位数组）
* 一系列随机函数 (哈希)
* 空间效率和查询效率高
* 有一定的误判率（哈希表是精确匹配）

布隆过滤器可以理解为一个不怎么精确的 set 结构，当你使用它的 contains 方法判断某
个对象是否存在时，它可能会误判。但是布隆过滤器也不是特别不精确，只要参数设置的合
理，它的精确度可以控制的相对足够精确，只会有小小的误判概率。



## 2.1 布隆过滤器的原理


布隆过滤器的数据结构里面就是一个大型的位数组和几个不一样的无
偏 hash 函数。所谓无偏就是能够把元素的 hash 值算得比较均匀。
向布隆过滤器中添加 key 时，会使用多个 hash 函数对 key 进行 hash 算得一个整数索引值然后对位数组长度进行取模运算得到一个位置，每个 hash 函数都会算得一个不同的位置。再把位数组的这几个位置都置为 1 就完成了 add 操作。

向布隆过滤器询问 key 是否存在时，跟 add 一样，也会把 hash 的几个位置都算出来，看看位数组中这几个位置是否都位 1，只要有一个位为 0，那么说明布隆过滤器中这个key 不存在。如果都是 1，这并不能说明这个 key 就一定存在，只是极有可能存在，因为这些位被置为 1 可能是因为其它的 key 存在所致。如果这个位数组比较稀疏，这个概率就会很大，如果这个位数组比较拥挤，这个概率就会降低。

![WX20191107-160458@2x.png](http://wx4.sinaimg.cn/large/007H8042ly1g8pjpc4yq9j30o00bsjsj.jpg)


![WX20191107-165708@2x.png](http://wx2.sinaimg.cn/large/007H8042ly1g8pkwaxky8j311u0de40m.jpg)

* 布隆过滤器的设计决定了它不能支持元素的删除


## 2.2 空间占用与误差

    1、 位数组相对越长 (l/n)，错误率 f 越低，这个和直观上理解是一致的
    2、 位数组相对越长 (l/n)，hash 函数需要的最佳数量也越多，影响计算效率
    3、 当一个元素平均需要 1 个字节 (8bit) 的指纹空间时 (l/n=8)，错误率大约为 2%
    4、 错误率为 10%，一个元素需要的平均指纹空间为 4.792 个 bit，大约为 5bit
    5、 错误率为 1%，一个元素需要的平均指纹空间为 9.585 个 bit，大约为 10bit
    6、 错误率为 0.1%，一个元素需要的平均指纹空间为 14.377 个 bit，大约为 15bit

你也许会想，如果一个元素需要占据 15 个 bit，那相对 set 集合的空间优势是不是就没有那么明显了？这里需要明确的是， set 中会存储每个元素的内容，而布隆过滤器仅仅存储元素的指纹。元素的内容大小就是字符串的长度，它一般会有多个字节，甚至是几十个上百个字节，每个元素本身还需要一个指针被 set 集合来引用，这个指针又会占去 4 个字节或 8 个字节，取决于系统是 32bit 还是 64bit。而指纹空间只有接近 2 个字节，所以布隆过滤器的空间优势还是非常明显的。解决去重问题，空间节省90%，有一定的误判概率


数学原理是两个完全随机的数字冲突的概率很小
常见的补救措施是建立一个小的白名单，存储重要的不能被误判的数据

### 2.2.1 误差计算
m比特，n个元素 ，每个元素对应k个哈希函数


![](https://www.zhihu.com/equation?tex=%5Cleft%5B+1-+%5Cleft%28+1-%5Cfrac%7B1%7D%7Bm%7D+%5Cright%29%5E%7Bnk%7D+%5Cright%5D%5E%7Bk%7D%5Capprox%5Cleft%28+1-e%5E%7B-kn%2Fm%7D+%5Cright%29%5E%7Bk%7D)


# 3、应用场景

* 爬虫系统，对URL进行去重，已经爬过的网页不再爬取

* 布隆过滤器在 NoSQL 数据库领域使用非常广泛，我们平时用到的 HBase、 Cassandra 还有 LevelDB、 RocksDB 内部都有布隆过滤器结构，布隆过滤器可以显著降低数据库的 IO请求数量。当用户来查询某个 row 时，可以先通过内存中的布隆过滤器过滤掉大量不存在的row 请求，然后再去磁盘进行查询。

* 邮箱系统的垃圾邮件过滤功能也普遍用到了布隆过滤器，因为用了这个过滤器，所以平时也会遇到某些正常的邮件被放进了垃圾邮件目录中，这个就是误判所致，概率很低。


# 4、延伸阅读

布谷鸟过滤器  https://cloud.tencent.com/developer/article/1447177

参考文档：
[详解布隆过滤器的原理，使用场景和注意事项](https://zhuanlan.zhihu.com/p/43263751)

Redis 深度历险： 核心原理与应用实践 | 钱文品 著